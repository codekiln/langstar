# devcontainers/features - CI Testing Analysis

## Repository Information

- **Repository**: [devcontainers/features](https://github.com/devcontainers/features)
- **Date Created**: 2025-11-21
- **Cloned to**: `/workspace/reference/repo/devcontainers/features/code`
- **Analysis Context**: Issue #246 - Research for implementing automated CI testing for langstar devcontainer feature (#240)

## Purpose

Analyze the official Microsoft devcontainers/features repository to understand production-grade CI testing patterns for devcontainer features. Extract actionable patterns for implementing similar testing in the langstar project.

## Key Findings

### CI Workflow Structure

The repository uses **three main CI workflows**:

1. **test-pr.yaml** - Tests only changed features on PRs
   - Uses `dorny/paths-filter@v3` to detect which features changed
   - Runs tests only for modified features (efficient)
   - Tests across 7 base images (Ubuntu, Debian variants)
   - Uses matrix strategy for parallel testing

2. **test-all.yaml** - Comprehensive testing on main branch
   - Tests ALL features on push to main
   - Same matrix strategy as PR tests
   - Ensures nothing breaks in integration

3. **linter-automated.yaml** - Shell script linting
   - Uses `azohra/shell-linter@v0.6.0` (ShellCheck wrapper)
   - Lints all shell scripts in `src/**/*.sh`
   - Runs on both PRs and main branch pushes

### Test Command Pattern

The core testing command used throughout:

```bash
# Install devcontainer CLI
npm install -g @devcontainers/cli

# Test a specific feature against a base image
devcontainer features test -f <feature-name> -i <base-image> .

# Test scenarios (test/*/scenarios.json)
devcontainer features test -f <feature-name> --skip-autogenerated .

# Test global scenarios
devcontainer features test --global-scenarios-only .
```

### Base Image Matrix

Features are tested against **7 base images**:
- ubuntu:focal
- ubuntu:jammy
- ubuntu:noble (24.04)
- debian:11
- debian:12
- mcr.microsoft.com/devcontainers/base:ubuntu
- mcr.microsoft.com/devcontainers/base:debian

### Test Structure Per Feature

Each feature has a `test/<feature-name>/` directory containing:

1. **test.sh** - Basic smoke test script
   - Uses `dev-container-features-test-lib` helper
   - Runs `check` commands to verify installation
   - Example: `check "cargo version" cargo --version`
   - Ends with `reportResults`

2. **scenarios.json** - Test scenarios with different configurations
   - Each scenario specifies: image, feature options
   - Tests different version combinations
   - Tests different component configurations
   - Tests different base OS distributions

3. **<scenario-name>.sh** - Scenario-specific test scripts
   - One script per scenario defined in scenarios.json
   - More detailed tests for specific configurations

### Example: Rust Feature Test Structure

```
test/rust/
├── scenarios.json          # 13 scenarios testing different configurations
├── test.sh                 # Basic smoke test (cargo/rustc version checks)
├── rust_at_pinned_version.sh
├── rust_with_target.sh
├── rust_with_custom_components.sh
└── ... (10 more scenario scripts)
```

**scenarios.json pattern**:
```json
{
  "rust_at_pinned_version": {
    "image": "ubuntu:noble",
    "features": {
      "rust": {
        "version": "1.64.0"
      }
    }
  }
}
```

**test.sh pattern**:
```bash
#!/bin/bash
set -e

# Import test library
source dev-container-features-test-lib

# Run checks
check "cargo version" cargo --version
check "rustc version" rustc --version

# Report results
reportResults
```

## CI Workflow Details

### PR Testing Workflow (test-pr.yaml)

**Key aspects**:

1. **Change Detection** (`detect-changes` job):
   - Uses `dorny/paths-filter@v3` action
   - Filters defined for each feature (`./**/rust/**`, etc.)
   - Outputs list of changed features as JSON array

2. **Test Job**:
   - Depends on `detect-changes`
   - Matrix: `features × baseImage`
   - Uses `continue-on-error: true` (doesn't block on failures)
   - Steps:
     1. Checkout code
     2. Install devcontainer CLI
     3. Run `devcontainer features test --skip-scenarios`

3. **Test Scenarios Job**:
   - Tests scenarios (from scenarios.json)
   - Only for changed features
   - Runs on custom runner: `devcontainer-image-builder-ubuntu`
   - Uses `--skip-autogenerated` flag

### Complete Testing Workflow (test-all.yaml)

**Differences from PR workflow**:
- No change detection - tests ALL features
- Triggered on: push to main, manual workflow_dispatch
- Same matrix and test approach

### Linting Workflow (linter-automated.yaml)

**Configuration**:
```yaml
- name: Shell Linter
  uses: azohra/shell-linter@v0.6.0
  with:
    path: "src/**/*.sh"
    severity: "error"
  env:
    SHELLCHECK_OPTS: -e SC2072
```

## Architecture

### Repository Structure

```
devcontainers/features/
├── .github/workflows/        # CI workflows
│   ├── test-pr.yaml          # PR testing (changed features only)
│   ├── test-all.yaml         # Full testing (all features)
│   ├── linter-automated.yaml # ShellCheck linting
│   └── ...
├── src/                      # Feature implementations
│   └── <feature-name>/
│       ├── devcontainer-feature.json
│       └── install.sh
└── test/                     # Feature tests
    └── <feature-name>/
        ├── test.sh           # Basic smoke test
        ├── scenarios.json    # Test scenarios
        └── *.sh              # Scenario-specific tests
```

### Test Library

Features use `dev-container-features-test-lib` which provides:
- `check "<description>" <command>` - Run command and verify exit code
- `reportResults` - Report pass/fail summary

## Actionable Recommendations for Langstar

### 1. Adopt the Same Test Command

Use `devcontainer features test` as the primary testing mechanism:

```bash
# Basic test
devcontainer features test -f langstar -i ubuntu:noble .

# Test across multiple base images
devcontainer features test -f langstar -i debian:12 .
```

### 2. Create test/langstar/ Directory

Structure:
```
test/langstar/
├── test.sh              # Basic smoke test
├── scenarios.json       # Different mise/rustup configurations
└── *.sh                 # Scenario-specific tests
```

### 3. Implement test.sh

```bash
#!/bin/bash
set -e

source dev-container-features-test-lib

# Test mise installation
check "mise version" mise --version

# Test rustup installation
check "rustup version" rustup --version

# Test cargo installation
check "cargo version" cargo --version

# Test rust compiler
check "rustc version" rustc --version

# Test mise.toml is configured
check "mise config exists" test -f ~/.config/mise/config.toml

reportResults
```

### 4. Create scenarios.json

Test different configurations:
```json
{
  "langstar_default": {
    "image": "ubuntu:noble",
    "features": {
      "langstar": {}
    }
  },
  "langstar_with_nightly": {
    "image": "ubuntu:noble",
    "features": {
      "langstar": {
        "rustChannel": "nightly"
      }
    }
  },
  "langstar_on_debian": {
    "image": "debian:12",
    "features": {
      "langstar": {}
    }
  }
}
```

### 5. Create GitHub Actions Workflow

**Minimal PR testing** (.github/workflows/test-pr.yaml):
```yaml
name: "PR - Test Langstar Feature"
on:
  pull_request:
    paths:
      - 'src/langstar/**'
      - 'test/langstar/**'
      - '.github/workflows/test-pr.yaml'

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        baseImage:
          - ubuntu:noble
          - ubuntu:jammy
          - debian:12
    steps:
      - uses: actions/checkout@v4

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Test langstar feature on ${{ matrix.baseImage }}
        run: devcontainer features test -f langstar -i ${{ matrix.baseImage }} .
```

### 6. Add ShellCheck Linting

**Linting workflow** (.github/workflows/lint.yaml):
```yaml
name: "Lint Shell Scripts"
on:
  pull_request:
  push:
    branches:
      - main

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Shell Linter
        uses: azohra/shell-linter@v0.6.0
        with:
          path: "src/**/*.sh"
          severity: "error"
```

### 7. Testing Strategy

**For PRs**:
- Test against 3-5 base images (Ubuntu 22.04, 24.04, Debian 12)
- Run linting on all shell scripts
- Keep it fast (< 5 minutes)

**For main branch**:
- More comprehensive matrix (7+ base images)
- Test all scenarios
- Can take longer

### 8. Use continue-on-error Strategically

From the upstream workflows:
```yaml
test:
  runs-on: ubuntu-latest
  continue-on-error: true  # Don't fail entire workflow on one test failure
```

This allows you to see all test results, not just the first failure.

## Notes

### Key Insights

1. **devcontainer CLI is the standard** - No custom test harness needed
2. **Matrix testing is essential** - Test across multiple base images
3. **Scenarios > Multiple test scripts** - Use scenarios.json for variations
4. **Linting is separate** - ShellCheck runs independently
5. **Change detection is powerful** - Only test what changed in PRs
6. **Test library is minimal** - Simple check/report pattern

### What NOT to do

❌ Don't manually build containers - use `devcontainer features test`
❌ Don't test in VS Code - CLI-based testing only
❌ Don't create complex test infrastructure - use existing patterns
❌ Don't skip linting - ShellCheck catches common issues
❌ Don't test everything on PRs - use change detection

### What TO do

✅ Use `devcontainer features test` command
✅ Create test.sh and scenarios.json
✅ Test across multiple base images
✅ Use dev-container-features-test-lib
✅ Run ShellCheck on all shell scripts
✅ Use matrix strategy for parallel testing
✅ Implement change detection for PRs

### Implementation Priority

**Phase 1 (MVP)**:
1. Create test/langstar/test.sh
2. Test against ubuntu:noble only
3. Run manually with `devcontainer features test`

**Phase 2 (CI Integration)**:
1. Create .github/workflows/test-pr.yaml
2. Test against 3 base images
3. Add ShellCheck linting

**Phase 3 (Comprehensive)**:
1. Add scenarios.json with multiple configurations
2. Expand base image matrix to 7+ images
3. Add test-all.yaml for main branch
4. Implement change detection

## References

- Workflow files: `/workspace/reference/repo/devcontainers/features/code/.github/workflows/`
- Test examples: `/workspace/reference/repo/devcontainers/features/code/test/rust/`
- Dev Container CLI docs: https://github.com/devcontainers/cli
- Test library: https://github.com/devcontainers/cli/blob/main/scripts/test-lib.sh
