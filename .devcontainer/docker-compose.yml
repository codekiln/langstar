# Docker Compose configuration for Langstar devcontainer
# Compose file format: https://docs.docker.com/compose/compose-file/
# Environment variables: https://docs.docker.com/compose/how-tos/environment-variables/
version: '3.8'

services:
  langstar-dev:
    build:
      context: .
      dockerfile: Dockerfile
      # Build arguments - can be overridden via .env file or environment
      # https://docs.docker.com/compose/compose-file/build/#args
      args:
        TZ: ${TZ:-America/New_York}
        CLAUDE_CODE_VERSION: ${CLAUDE_CODE_VERSION:-latest}
        GIT_DELTA_VERSION: ${GIT_DELTA_VERSION:-0.18.2}
        ZSH_IN_DOCKER_VERSION: ${ZSH_IN_DOCKER_VERSION:-1.2.1}

    # Add Linux capabilities for VPN/network tools
    # https://docs.docker.com/compose/compose-file/compose-file-v3/#cap_add
    cap_add:
      - NET_ADMIN
      - NET_RAW

    # Environment variables passed to the container
    # Syntax: ${VAR:-default} means use VAR if set, otherwise use default
    # https://docs.docker.com/compose/how-tos/environment-variables/variable-interpolation/
    #
    # IMPORTANT: ALL variables that should be available in the container MUST be
    # declared in this environment: section. Docker Compose loads values from .env
    # and substitutes them here using ${VAR} syntax. If a variable is in .env but
    # NOT listed here, it won't be available in the container shell.
    #
    # To add a new environment variable:
    # 1. Add value to .env file (e.g., MY_VAR=value)
    # 2. Add declaration here (e.g., MY_VAR: ${MY_VAR})
    # 3. Rebuild devcontainer
    #
    # See .env.default and docker-compose.override.yml.template for full docs
    environment:
      # GitHub Authentication
      # Local: Uses GITHUB_PAT from .env file
      # Codespaces: Falls back to GH_PAT from secrets
      GITHUB_PAT: ${GITHUB_PAT:-${GH_PAT}}
      GITHUB_USER: ${GITHUB_USER:-${GH_USER}}
      GITHUB_PROJECT_PAT: ${GITHUB_PROJECT_PAT:-${GH_PROJECT_PAT}}

      # Anthropic Configuration
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-us.anthropic.claude-sonnet-4-5-20250929-v1:0}
      ANTHROPIC_SMALL_FAST_MODEL: ${ANTHROPIC_SMALL_FAST_MODEL:-us.anthropic.claude-haiku-4-5-20251001-v1:0}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      CLAUDE_CODE_USE_BEDROCK: ${CLAUDE_CODE_USE_BEDROCK:-1}

      # LangChain API Configuration
      # Both LangSmith and LangGraph Cloud use LANGSMITH_API_KEY for authentication
      LANGSMITH_API_KEY: ${LANGSMITH_API_KEY}
      LANGSMITH_ORGANIZATION_NAME: ${LANGSMITH_ORGANIZATION_NAME}
      LANGSMITH_ORGANIZATION_ID: ${LANGSMITH_ORGANIZATION_ID}
      LANGSMITH_WORKSPACE_NAME: ${LANGSMITH_WORKSPACE_NAME}
      LANGSMITH_WORKSPACE_ID: ${LANGSMITH_WORKSPACE_ID}
      LANGCHAIN_WORKSPACE_ID: ${LANGCHAIN_WORKSPACE_ID}

      # Test LangGraph Deployment (for Phase 5 integration testing)
      TEST_GRAPH_ID: ${TEST_GRAPH_ID}
      TEST_DEPLOYMENT_ID: ${TEST_DEPLOYMENT_ID}

      # Container Environment
      NODE_OPTIONS: --max-old-space-size=4096
      CLAUDE_CONFIG_DIR: /home/node/.claude
      POWERLEVEL9K_DISABLE_GITSTATUS: "true"

      # Claude Code Token Configuration
      # max_tokens must be greater than thinking.budget_tokens
      # Recommended for Bedrock: MAX_OUTPUT=4096, THINKING=1024
      # https://docs.claude.com/en/docs/build-with-claude/extended-thinking
      CLAUDE_CODE_MAX_OUTPUT_TOKENS: ${CLAUDE_CODE_MAX_OUTPUT_TOKENS:-4096}
      MAX_THINKING_TOKENS: ${MAX_THINKING_TOKENS:-1024}

      # Legacy variables (if needed)
      GITHUB_TOKEN: ${GITHUB_TOKEN:-${DEVCONTAINER_GITHUB_TOKEN}}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-${DEVCONTAINER_OPENAI_API_KEY}}

    # Volume mounts
    # https://docs.docker.com/compose/compose-file/compose-file-v3/#volumes
    volumes:
      # Mount workspace directory with cached consistency for better performance
      # https://docs.docker.com/compose/compose-file/compose-file-v3/#caching-options-for-volume-mounts-docker-desktop
      - ..:/workspace:cached

      # Named volumes for persistent data across container rebuilds
      # These survive even when the container is deleted
      - claude-code-bashhistory:/commandhistory
      - claude-code-config:/home/node/.claude

    # Keep container running (required for devcontainers)
    # https://docs.docker.com/compose/compose-file/compose-file-v3/#command
    command: sleep infinity

    # Run container as 'node' user (matches Dockerfile USER directive)
    # https://docs.docker.com/compose/compose-file/compose-file-v3/#user
    user: node

# Named volumes declaration
# https://docs.docker.com/compose/compose-file/compose-file-v3/#volume-configuration-reference
volumes:
  # Persistent bash history across container rebuilds
  claude-code-bashhistory:
  # Persistent Claude configuration across container rebuilds
  claude-code-config:
